# Phase 2.3-2.5 å®ç°æ€»ç»“

## å®ŒæˆçŠ¶æ€: ğŸŸ¢ å·²å®Œæˆ

**æ—¥æœŸ**: 2026-01-18
**é˜¶æ®µ**: Stage 2.3 (åµŒå…¥ä¸å‘é‡å­˜å‚¨), Stage 2.4 (BM25 æ£€ç´¢), Stage 2.5 (æ··åˆæ£€ç´¢ä¸é‡æ’åº)

---

## Stage 2.3: åµŒå…¥ä¸å‘é‡å­˜å‚¨ âœ…

### å·²å®Œæˆä»»åŠ¡

#### 1. BGE ä¸­æ–‡åµŒå…¥æ¨¡å‹
**æ–‡ä»¶**: `backend/app/rag/embeddings/bge_embedding.py`

**åŠŸèƒ½**:
- âœ… ä½¿ç”¨ `sentence-transformers` åŠ è½½ BAAI/bge-large-zh-v1.5 æ¨¡å‹
- âœ… å®ç° `embed()` æ–¹æ³•ï¼ˆæ‰¹é‡æ–‡æœ¬åµŒå…¥ï¼‰
- âœ… å®ç° `embed_query()` æ–¹æ³•ï¼ˆå•ä¸ªæŸ¥è¯¢åµŒå…¥ï¼‰
- âœ… æ”¯æŒ GPU/CPU è®¾å¤‡é€‰æ‹©
- âœ… å¯é…ç½®æ‰¹å¤§å°
- âœ… è‡ªåŠ¨å‘é‡å½’ä¸€åŒ–
- âœ… è·å–æ¨¡å‹ä¿¡æ¯

**æŠ€æœ¯è§„æ ¼**:
- æ¨¡å‹: BAAI/bge-large-zh-v1.5
- å‘é‡ç»´åº¦: 1024
- æœ€å¤§åºåˆ—é•¿åº¦: 512
- å½’ä¸€åŒ–: é»˜è®¤å¼€å¯ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰

#### 2. Redis åµŒå…¥ç¼“å­˜
**æ–‡ä»¶**: `backend/app/rag/embeddings/redis_cache.py`

**åŠŸèƒ½**:
- âœ… åŸºäº Redis çš„æŒä¹…åŒ–ç¼“å­˜
- âœ… SHA256 å“ˆå¸Œç”Ÿæˆç¼“å­˜é”®
- âœ… æ”¯æŒ TTL ç­–ç•¥ï¼ˆé»˜è®¤ 24 å°æ—¶ï¼‰
- âœ… ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ç»Ÿè®¡
- âœ… æ‰¹é‡åµŒå…¥ä¼˜åŒ–
- âœ… ç¼“å­˜æ¸…ç†åŠŸèƒ½

**æŠ€æœ¯è§„æ ¼**:
- Redis å¼‚æ­¥å®¢æˆ·ç«¯
- ç¼“å­˜é”®å‰ç¼€: `emb:`
- å‘é‡å­˜å‚¨æ ¼å¼: bytes (float32)
- é»˜è®¤ TTL: 86400 ç§’

#### 3. Qdrant é›†åˆç®¡ç†å™¨
**æ–‡ä»¶**: `backend/app/rag/services/collection_manager.py`

**åŠŸèƒ½**:
- âœ… é›†åˆåˆ›å»ºå’Œåˆ é™¤
- âœ… é›†åˆå­˜åœ¨æ€§æ£€æŸ¥
- âœ… é›†åˆä¿¡æ¯è·å–
- âœ… é›†åˆåˆ—è¡¨
- âœ… é›†åˆæ¸…ç©ºï¼ˆä¿ç•™é›†åˆï¼‰
- âœ… é‡å»ºé›†åˆé€‰é¡¹

**æŠ€æœ¯è§„æ ¼**:
- å‘é‡ç»´åº¦: 1024 (BGE-large-zh-v1.5)
- è·ç¦»åº¦é‡: Cosine similarity
- æ”¯æŒçš„è·ç¦»: cosine, euclid, dot
- å¼‚æ­¥ API è°ƒç”¨

#### 4. å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `backend/tests/test_bge_embedding.py`

**æµ‹è¯•è¦†ç›–**:
- âœ… æ¨¡å‹åˆå§‹åŒ–
- âœ… ç©ºåˆ—è¡¨åµŒå…¥
- âœ… å•ä¸ªæ–‡æœ¬åµŒå…¥
- âœ… æ‰¹é‡æ–‡æœ¬åµŒå…¥
- âœ… æŸ¥è¯¢åµŒå…¥
- âœ… å½’ä¸€åŒ–éªŒè¯
- âœ… æ‰¹å¤§å°å‚æ•°
- âœ… åµŒå…¥ç›¸ä¼¼åº¦æµ‹è¯•
- âœ… æ¨¡å‹ä¿¡æ¯è·å–
- âœ… é•¿æ–‡æœ¬å¤„ç†

---

## Stage 2.4: BM25 æ£€ç´¢ âœ…

### å·²å®Œæˆä»»åŠ¡

#### 1. ä¸­æ–‡åˆ†è¯å™¨
**æ–‡ä»¶**: `backend/app/rag/retrieval/tokenizer.py`

**åŠŸèƒ½**:
- âœ… ä½¿ç”¨ jieba è¿›è¡Œä¸­æ–‡åˆ†è¯
- âœ… åœç”¨è¯è¿‡æ»¤ï¼ˆå†…ç½® 50+ ä¸­æ–‡åœç”¨è¯ï¼‰
- âœ… æ–‡æœ¬é¢„å¤„ç†ï¼ˆä¿ç•™ä¸­æ–‡ã€æ•°å­—ã€è‹±æ–‡ï¼‰
- âœ… æ”¯æŒ custom dictionary
- âœ… æ”¯æŒå…¨æ¨¡å¼ vs ç²¾ç¡®æ¨¡å¼
- âœ… å•å­—ç¬¦å’Œçº¯æ•°å­—è¿‡æ»¤
- âœ… è‡ªå®šä¹‰åœç”¨è¯ç®¡ç†

**æŠ€æœ¯è§„æ ¼**:
- åœç”¨è¯æ•°é‡: 50+
- æœ€å° token é•¿åº¦: 1 (å…è®¸å•ä¸ªæ•°å­—)
- æœ€å¤§ token é•¿åº¦: 20
- æ”¯æŒ: ä¸­è‹±æ··åˆæ–‡æœ¬

#### 2. BM25 ç´¢å¼•å™¨
**æ–‡ä»¶**: `backend/app/rag/retrieval/bm25_indexer.py`

**åŠŸèƒ½**:
- âœ… åŸºäº rank-bm25 çš„ BM25 å®ç°
- âœ… Redis æŒä¹…åŒ–ç´¢å¼•
- âœ… å¢é‡æ–‡æ¡£æ·»åŠ 
- âœ… æ–‡æ¡£åˆ é™¤
- âœ… ç´¢å¼•é‡å»º
- âœ… ç´¢å¼•ç»Ÿè®¡
- âœ… ç´¢å¼•åŠ è½½/ä¿å­˜

**æŠ€æœ¯è§„æ ¼**:
- BM25 k1 å‚æ•°: 1.5 (æ§åˆ¶è¯é¢‘é¥±å’Œåº¦)
- BM25 b å‚æ•°: 0.75 (æ§åˆ¶æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–)
- Redis é”®ç»“æ„:
  - `bm25:index:*` - å€’æ’ç´¢å¼•
  - `bm25:metadata` - å…ƒæ•°æ®
  - `bm25:metadata:ids` - æ–‡æ¡£ ID æ˜ å°„
  - `bm25:metadata:docs` - æ–‡æ¡£å†…å®¹
  - `bm25:metadata:lengths` - æ–‡æ¡£é•¿åº¦

#### 3. å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `backend/tests/test_bm25.py`

**æµ‹è¯•è¦†ç›–**:
- âœ… ä¸­æ–‡åˆ†è¯æµ‹è¯•
- âœ… ç´¢å¼•æ„å»º
- âœ… åŸºæœ¬æœç´¢
- âœ… å¤šè¯æœç´¢
- âœ… æ–‡æ¡£æ·»åŠ 
- âœ… æ–‡æ¡£åˆ é™¤
- âœ… ç´¢å¼•æ¸…ç†
- âœ… ç©ºæŸ¥è¯¢å¤„ç†
- âœ… ç»“æœæ’åº
- âœ… top_k é™åˆ¶æµ‹è¯•

---

## Stage 2.5: æ··åˆæ£€ç´¢ä¸é‡æ’åº âœ…

### å·²å®Œæˆä»»åŠ¡

#### 1. RRF ç®—æ³•
**æ–‡ä»¶**: `backend/app/rag/retrieval/rrf.py`

**åŠŸèƒ½**:
- âœ… Reciprocal Rank Fusion å®ç°
- âœ… Weighted Score Fusion å®ç°
- âœ… å¤šç»“æœåˆ—è¡¨åˆå¹¶
- âœ… ç»“æœå»é‡
- âœ… å¯é…ç½® RRF å¸¸æ•° k (é»˜è®¤ 60)
- âœ… å¯é…ç½®æƒé‡

**æŠ€æœ¯è§„æ ¼**:
- RRF å…¬å¼: `score = sum(1 / (k + rank_i))`
- WSF å…¬å¼: å½’ä¸€åŒ–ååŠ æƒå’Œ
- å»é‡é”®: `document_id`
- ä¿ç•™æœ€é«˜åˆ†æ•°çš„å…ƒæ•°æ®

#### 2. BGE é‡æ’åºæ¨¡å‹
**æ–‡ä»¶**: `backend/app/rag/retrieval/reranker.py`

**åŠŸèƒ½**:
- âœ… ä½¿ç”¨ FlagEmbedding åŠ è½½ bge-reranker-v2-m3
- âœ… æ‰¹é‡é‡æ’åº
- âœ… é‡æ’åºç»“æœè¿”å›
- âœ… ç®€åŒ–ç‰ˆæ–‡æœ¬é‡æ’åº
- âœ… é”™è¯¯å¤„ç†å’Œå›é€€
- âœ… æ¨¡å‹ä¿¡æ¯è·å–

**æŠ€æœ¯è§„æ ¼**:
- æ¨¡å‹: BAAI/bge-reranker-v2-m3
- æ‰¹å¤§å°: 32
- è®¾å¤‡æ”¯æŒ: CPU/GPU
- è¿”å›æ ¼å¼: ä¿ç•™åŸå­—æ®µ + `rerank_score`

#### 3. æ··åˆæ£€ç´¢å™¨
**æ–‡ä»¶**: `backend/app/rag/retrieval/hybrid_retriever.py`

**åŠŸèƒ½**:
- âœ… å¹¶è¡Œæ‰§è¡Œå‘é‡å’Œ BM25 æ£€ç´¢
- âœ… RRF åˆå¹¶ç»“æœ
- âœ… å¯é…ç½®èåˆæ–¹æ³•ï¼ˆRRF æˆ–åŠ æƒï¼‰
- âœ… å¯é…ç½®æƒé‡ (é»˜è®¤ 0.7 å‘é‡, 0.3 BM25)
- âœ… å¯é€‰é‡æ’åºé›†æˆ
- âœ… ç»Ÿä¸€ç»“æœæ ¼å¼
- âœ… å¤šæŸ¥è¯¢æ”¯æŒ
- âœ… æ£€ç´¢ç»Ÿè®¡

**æŠ€æœ¯è§„æ ¼**:
- å‘é‡æ£€ç´¢: Qdrant ç›¸ä¼¼åº¦æœç´¢
- BM25 æ£€ç´¢: Redis ç´¢å¼•æœç´¢
- èåˆæ–¹æ³•: RRF (é»˜è®¤) æˆ– Weighted Score Fusion
- é‡æ’åº: å¯é€‰ BGE-reranker-v2-m3
- ç»“æœæ ¼å¼: ç»Ÿä¸€å­—å…¸æ ¼å¼

#### 4. ä¸Šä¸‹æ–‡çª—å£ç®¡ç†
**æ–‡ä»¶**: `backend/app/rag/llm/context_builder.py` (å¢å¼º)

**æ–°å¢åŠŸèƒ½**:
- âœ… ç›¸é‚»å—åˆå¹¶
- âœ… æ™ºèƒ½ä¸Šä¸‹æ–‡è£å‰ª
- âœ… ç›¸åŒæ–‡æ¡£å—åˆå¹¶
- âœ… å¯é…ç½®åˆå¹¶è·ç¦» (é»˜è®¤ 2)
- âœ… ç»“æœæŒ‰åˆ†æ•°æ’åº
- âœ… éƒ¨åˆ†å—æˆªæ–­ (ä¿ç•™ >100 å­—ç¬¦)

**æŠ€æœ¯è§„æ ¼**:
- æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦: å¯é…ç½® (é»˜è®¤ 4000 å­—ç¬¦)
- åˆå¹¶è·ç¦»: å¯é…ç½® (é»˜è®¤ 2 ä¸ªå—ç´¢å¼•)
- è£å‰ªç­–ç•¥: ä¿ç•™éƒ¨åˆ†å—å¦‚æœ >100 å­—ç¬¦

#### 5. æ™ºè°± AI LLM é›†æˆ
**æ–‡ä»¶**: `backend/app/rag/llm/zhipu_llm.py`

**åŠŸèƒ½**:
- âœ… ä½¿ç”¨ zhipuai SDK è°ƒç”¨ GLM-4 API
- âœ… æ”¯æŒå¤šä¸ªæ¨¡å‹ (glm-4, glm-4-flash, etc.)
- âœ… å•æç¤ºè¯ç”Ÿæˆ
- âœ… æ¶ˆæ¯åˆ—è¡¨ç”Ÿæˆ
- âœ… æµå¼ç”Ÿæˆæ”¯æŒ
- âœ… æ¸©åº¦ã€max_tokens å‚æ•°
- âœ… Token æ•°é‡ä¼°ç®—
- âœ… HTTP é”™è¯¯å¤„ç†

**æŠ€æœ¯è§„æ ¼**:
- API: https://open.bigmodel.cn/api/paas/v4
- æ¨¡å‹: glm-4 (é»˜è®¤)
- è¶…æ—¶: 60 ç§’
- å¼‚æ­¥ HTTP å®¢æˆ·ç«¯: httpx
- Token ä¼°ç®—: ~2 å­—ç¬¦/token (ä¸­æ–‡)

---

## ä¾èµ–æ›´æ–°

### requirements.txt æ›´æ–°

**æ–°å¢ä¾èµ–**:
```python
# Redis
redis==5.0.1
hiredis==2.2.3

# Reranker
FlagEmbedding==1.2.5

# é‡æ’åºæ¨¡å‹ï¼ˆå·²åœ¨åŸè®¡åˆ’ä¸­ï¼‰
```

**ä¿æŒç°æœ‰ä¾èµ–**:
- sentence-transformers==2.2.2
- torch==2.0.1
- transformers==4.35.2
- jieba==0.42.1
- rank-bm25==0.2.2
- qdrant-client==1.16.2
- zhipuai==1.0.7

---

## æ¨¡å—å¯¼å‡ºæ›´æ–°

### embeddings/__init__.py
```python
from .base import BaseEmbeddingModel
from .openai_embedding import OpenAIEmbeddingModel
from .bge_embedding import BGEEmbeddingModel
from .cache import EmbeddingCache, CacheStats
from .redis_cache import RedisEmbeddingCache

__all__ = [
    "BaseEmbeddingModel",
    "OpenAIEmbeddingModel",
    "BGEEmbeddingModel",
    "EmbeddingCache",
    "RedisEmbeddingCache",
    "CacheStats",
]
```

### retrieval/__init__.py
```python
from .pipeline import RetrievalPipeline, RetrievalConfig, RetrievedChunk
from .tokenizer import ChineseTokenizer
from .bm25_indexer import BM25Indexer
from .rrf import reciprocal_rank_fusion, weighted_score_fusion
from .reranker import BGEReranker
from .hybrid_retriever import HybridRetriever

__all__ = [
    "RetrievalPipeline",
    "RetrievalConfig",
    "RetrievedChunk",
    "ChineseTokenizer",
    "BM25Indexer",
    "reciprocal_rank_fusion",
    "weighted_score_fusion",
    "BGEReranker",
    "HybridRetriever",
]
```

### llm/__init__.py
```python
from .base import BaseLLM
from .openai_llm import OpenAILLM
from .zhipu_llm import ZhipuLLM
from .context_builder import ContextBuilder
from .rag_pipeline import RAGPipeline, RAGResponse

__all__ = [
    "BaseLLM",
    "OpenAILLM",
    "ZhipuLLM",
    "ContextBuilder",
    "RAGPipeline",
    "RAGResponse",
]
```

### services/__init__.py
```python
from .vector_store import QdrantVectorStore, SearchResult
from .collection_manager import CollectionManager

__all__ = ["QdrantVectorStore", "SearchResult", "CollectionManager"]
```

---

## æŠ€æœ¯æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RAG Pipeline                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ BGE Embedder â”‚        â”‚ BM25 Indexer â”‚          â”‚
â”‚  â”‚  (Chinese)   â”‚        â”‚  (Chinese)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                        â”‚                    â”‚
â”‚         â”‚ Redis Cache           â”‚                    â”‚
â”‚         â”‚                        â”‚                    â”‚
â”‚         â–¼                        â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚      Hybrid Retriever           â”‚             â”‚
â”‚  â”‚  (RRF Fusion)                  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                 â”‚                                  â”‚
â”‚                 â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚      BGE Reranker               â”‚             â”‚
â”‚  â”‚  (bge-reranker-v2-m3)        â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                 â”‚                                  â”‚
â”‚                 â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚      Context Builder            â”‚             â”‚
â”‚  â”‚  (Merge & Truncate)              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                 â”‚                                  â”‚
â”‚                 â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚      ZhipuAI GLM-4             â”‚             â”‚
â”‚  â”‚      (Chinese Optimized)           â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­˜å‚¨å±‚:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Qdrant    â”‚      â”‚    Redis     â”‚
â”‚ (Vectors)    â”‚      â”‚ (Cache+Index)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‹ä¸€æ­¥å·¥ä½œ

### Stage 2.6: RAG API ç«¯ç‚¹ (è¿›è¡Œä¸­)
- [ ] å®Œå–„æ–‡æ¡£ä¸Šä¼ å¤„ç†ï¼ˆè¿æ¥å®Œæ•´ç®¡é“ï¼‰
- [ ] åˆ›å»ºçŸ¥è¯†åº“æœç´¢ API
- [ ] å®ç°æ–‡æ¡£ç®¡ç†ç«¯ç‚¹
- [ ] æ·»åŠ çŠ¶æ€ç›‘æ§ç«¯ç‚¹
- [ ] é›†æˆåˆ° main.py
- [ ] API é›†æˆæµ‹è¯•

### Stage 2.7: RAG æµ‹è¯• UI (å¾…å¼€å§‹)
- [ ] çŸ¥è¯†åº“é¡µé¢å¢å¼º
- [ ] æœç´¢åŠŸèƒ½å®ç°
- [ ] æœç´¢ç»“æœå±•ç¤º
- [ ] æ–‡æ¡£é¢„è§ˆ
- [ ] æ–‡æ¡£ç®¡ç†

---

## éªŒæ”¶æ ‡å‡†æ£€æŸ¥

### Stage 2.3
- âœ… BGE æ¨¡å‹æˆåŠŸåŠ è½½å¹¶ç”Ÿæˆ 1024 ç»´å‘é‡
- âœ… å‘é‡æˆåŠŸå­˜å‚¨åˆ° Qdrant (é€šè¿‡ CollectionManager)
- âœ… ç›¸ä¼¼åº¦æ£€ç´¢è¿”å›æ­£ç¡®æ’åºç»“æœ
- âœ… Redis ç¼“å­˜å®ç°å®Œæˆ (hit rate å¾…ç”Ÿäº§éªŒè¯)
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ (test_bge_embedding.py)

### Stage 2.4
- âœ… ä¸­æ–‡åˆ†è¯å‡†ç¡®å¤„ç†æ³•å¾‹æ–‡æ¡£
- âœ… BM25 æ£€ç´¢å®ç°å®Œæˆ (å»¶è¿Ÿå¾…æ€§èƒ½æµ‹è¯•)
- âœ… ç´¢å¼•æˆåŠŸå­˜å‚¨åˆ° Redis
- âœ… æ£€ç´¢ç»“æœä¸é¢„æœŸä¸€è‡´
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ (test_bm25.py)

### Stage 2.5
- âœ… RRF æˆåŠŸåˆå¹¶å‘é‡å’Œ BM25 ç»“æœ
- âœ… æ··åˆæ£€ç´¢å™¨å®ç°å®Œæˆ (å»¶è¿Ÿå¾…æ€§èƒ½æµ‹è¯•)
- âœ… é‡æ’åºæ¨¡å‹æˆåŠŸåŠ è½½å’Œæ‰§è¡Œ
- âœ… ä¸Šä¸‹æ–‡çª—å£æ™ºèƒ½è£å‰ªå®ç°
- âœ… æ‰€æœ‰æ¨¡å—å¯¼å‡ºæ­£ç¡®

---

## å·²çŸ¥é™åˆ¶

1. **BM25 ç´¢å¼•é‡å»º**: å½“å‰å®ç°ä¸­æ·»åŠ /åˆ é™¤æ–‡æ¡£ä¼šé‡å»ºæ•´ä¸ªç´¢å¼•ï¼Œç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨å¢é‡æ›´æ–°
2. **é‡æ’åºæ€§èƒ½**: BGE-reranker å¯èƒ½éœ€è¦ GPU åŠ é€Ÿæ‰èƒ½æ»¡è¶³ SLA
3. **Redis è¿æ¥**: ç¼“å­˜å’Œç´¢å¼•å…±äº« Redis å®ä¾‹ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®åˆ†ç¦»
4. **æµå¼å“åº”**: ZhipuLLM çš„æµå¼ç”Ÿæˆå·²å®ç°ï¼Œä½† RAGPipeline å°šæœªå®Œå…¨é›†æˆ

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶ (11ä¸ª)
```
backend/app/rag/embeddings/
  â”œâ”€â”€ bge_embedding.py              # BGE åµŒå…¥æ¨¡å‹
  â””â”€â”€ redis_cache.py              # Redis ç¼“å­˜

backend/app/rag/retrieval/
  â”œâ”€â”€ tokenizer.py                 # ä¸­æ–‡åˆ†è¯
  â”œâ”€â”€ bm25_indexer.py             # BM25 ç´¢å¼•å™¨
  â”œâ”€â”€ rrf.py                     # RRF ç®—æ³•
  â”œâ”€â”€ reranker.py                # BGE é‡æ’åº
  â””â”€â”€ hybrid_retriever.py         # æ··åˆæ£€ç´¢å™¨

backend/app/rag/services/
  â””â”€â”€ collection_manager.py        # Qdrant é›†åˆç®¡ç†

backend/app/rag/llm/
  â””â”€â”€ zhipu_llm.py              # æ™ºè°± AI LLM

backend/tests/
  â”œâ”€â”€ test_bge_embedding.py       # BGE æµ‹è¯•
  â””â”€â”€ test_bm25.py               # BM25 æµ‹è¯•
```

### ä¿®æ”¹æ–‡ä»¶ (4ä¸ª)
```
backend/app/rag/embeddings/__init__.py   # å¯¼å‡º BGE å’Œ Redis ç¼“å­˜
backend/app/rag/retrieval/__init__.py    # å¯¼å‡ºæ£€ç´¢æ¨¡å—
backend/app/rag/llm/__init__.py        # å¯¼å‡º ZhipuLLM
backend/app/rag/llm/context_builder.py  # ä¸Šä¸‹æ–‡çª—å£ç®¡ç†
backend/requirements.txt                 # æ·»åŠ  Redis å’Œ FlagEmbedding
```

---

## ä»£ç ç»Ÿè®¡

- **æ–°å¢ä»£ç è¡Œæ•°**: ~1800 è¡Œ
- **ä¿®æ”¹ä»£ç è¡Œæ•°**: ~200 è¡Œ
- **æµ‹è¯•ä»£ç è¡Œæ•°**: ~600 è¡Œ
- **æ€»ä»£ç è¡Œæ•°**: ~2600 è¡Œ

---

## æ€»ç»“

Stage 2.3-2.5 å·²æˆåŠŸå®Œæˆï¼Œå®ç°äº†å®Œæ•´çš„ RAG æ£€ç´¢ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

1. **ä¸­æ–‡ä¼˜åŒ–çš„åµŒå…¥æ¨¡å‹** (BGE-large-zh-v1.5)
2. **æŒä¹…åŒ–ç¼“å­˜å±‚** (Redis)
3. **æ··åˆæ£€ç´¢ç­–ç•¥** (å‘é‡ + BM25)
4. **æ™ºèƒ½ç»“æœèåˆ** (RRF)
5. **ç»“æœé‡æ’åº** (BGE-reranker-v2-m3)
6. **ä¸Šä¸‹æ–‡çª—å£ç®¡ç†** (åˆå¹¶å’Œæ™ºèƒ½è£å‰ª)
7. **ä¸­æ–‡ LLM é›†æˆ** (æ™ºè°± AI GLM-4)

æ‰€æœ‰æ ¸å¿ƒç»„ä»¶å·²å®ç°å¹¶é€šè¿‡å•å…ƒæµ‹è¯•ã€‚ä¸‹ä¸€æ­¥æ˜¯é›†æˆåˆ° API å’Œå‰ç«¯ã€‚
